import React, { useState, useEffect, useRef } from 'react';

const BOARD_WIDTH = 10;
const BOARD_HEIGHT = 20;
const CELL_SIZE = 30;

const SHAPES = [
  { shape: [[1,1,1,1]], color: '#00F0F0' }, // I - Cyan
  { shape: [[1,1],[1,1]], color: '#F0F000' }, // O - Yellow
  { shape: [[0,1,0],[1,1,1]], color: '#A000F0' }, // T - Purple
  { shape: [[1,0,0],[1,1,1]], color: '#F0A000' }, // L - Orange
  { shape: [[0,0,1],[1,1,1]], color: '#0000F0' }, // J - Blue
  { shape: [[1,1,0],[0,1,1]], color: '#00F000' }, // S - Green
  { shape: [[0,1,1],[1,1,0]], color: '#F00000' }, // Z - Red
];

const QUESTIONS = [
  { q: "What does the anther produce?", a: ["Pollen", "Seeds", "Nectar", "Ovules"], correct: 0 },
  { q: "What are the female parts of a flower called?", a: ["Carpel", "Stamen", "Sepal", "Petal"], correct: 0 },
  { q: "What is a plant's growth response to light called?", a: ["Phototropism", "Geotropism", "Hydrotropism", "Thigmotropism"], correct: 0 },
  { q: "Which pollination method uses bright petals?", a: ["Insect", "Wind", "Water", "Self"], correct: 0 },
  { q: "What type of reproduction produces identical offspring?", a: ["Asexual", "Sexual", "Binary", "Budding"], correct: 0 },
  { q: "What is the binomial name format?", a: ["Genus species", "species Genus", "GENUS SPECIES", "Family species"], correct: 0 },
  { q: "Roots grow downward showing positive...", a: ["Gravitropism", "Phototropism", "Hydrotropism", "Chemotropism"], correct: 0 },
  { q: "What cell wall material do plants have?", a: ["Cellulose", "Chitin", "Peptidoglycan", "Protein"], correct: 0 },
  { q: "What are wind-pollinated pollen grains like?", a: ["Small & light", "Large & sticky", "Colorful", "Heavy"], correct: 0 },
  { q: "What does the ovary become after fertilization?", a: ["Fruit", "Seed", "Petal", "Root"], correct: 0 },
  { q: "Shoots grow toward light, showing positive...", a: ["Phototropism", "Geotropism", "Gravitropism", "Thigmotropism"], correct: 0 },
  { q: "How many domains are in the modern classification?", a: ["3", "2", "5", "6"], correct: 0 },
  { q: "What produces nectar in flowers?", a: ["Nectaries", "Anthers", "Stigma", "Ovules"], correct: 0 },
  { q: "The stigma in insect-pollinated flowers is...", a: ["Sticky", "Feathery", "Smooth", "Dry"], correct: 0 },
];

export default function BioTetris() {
  const [board, setBoard] = useState(Array(BOARD_HEIGHT).fill().map(() => Array(BOARD_WIDTH).fill(null)));
  const [currentPiece, setCurrentPiece] = useState(null);
  const [nextPiece, setNextPiece] = useState(null);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [score, setScore] = useState(0);
  const [lines, setLines] = useState(0);
  const [gameOver, setGameOver] = useState(false);
  const [paused, setPaused] = useState(false);
  const [level, setLevel] = useState(1);
  const [showQuestion, setShowQuestion] = useState(false);
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [powerUps, setPowerUps] = useState({ clearRow: 0 });
  const [correctAnswers, setCorrectAnswers] = useState(0);
  const [gameStarted, setGameStarted] = useState(false);
  const gameLoopRef = useRef(null);

  const spawnPiece = () => {
    const piece = nextPiece || SHAPES[Math.floor(Math.random() * SHAPES.length)];
    const newNext = SHAPES[Math.floor(Math.random() * SHAPES.length)];
    const x = Math.floor(BOARD_WIDTH / 2) - Math.floor(piece.shape[0].length / 2);
    setCurrentPiece(piece);
    setNextPiece(newNext);
    setPosition({ x, y: 0 });
    
    if (checkCollision(piece.shape, { x, y: 0 })) {
      setGameOver(true);
      setGameStarted(false);
    }
  };

  const checkCollision = (shape, pos) => {
    for (let y = 0; y < shape.length; y++) {
      for (let x = 0; x < shape[y].length; x++) {
        if (shape[y][x]) {
          const newY = pos.y + y;
          const newX = pos.x + x;
          if (newY >= BOARD_HEIGHT || newX < 0 || newX >= BOARD_WIDTH || 
              (newY >= 0 && board[newY][newX])) {
            return true;
          }
        }
      }
    }
    return false;
  };

  const mergePiece = () => {
    const newBoard = board.map(row => [...row]);
    currentPiece.shape.forEach((row, y) => {
      row.forEach((cell, x) => {
        if (cell) {
          const boardY = position.y + y;
          const boardX = position.x + x;
          if (boardY >= 0 && boardY < BOARD_HEIGHT) {
            newBoard[boardY][boardX] = currentPiece.color;
          }
        }
      });
    });
    setBoard(newBoard);
    clearLines(newBoard);
    
    if (Math.random() < 0.25) {
      showQuizQuestion();
    } else {
      spawnPiece();
    }
  };

  const clearLines = (currentBoard) => {
    let linesCleared = 0;
    const newBoard = currentBoard.filter(row => {
      if (row.every(cell => cell !== null)) {
        linesCleared++;
        return false;
      }
      return true;
    });
    
    while (newBoard.length < BOARD_HEIGHT) {
      newBoard.unshift(Array(BOARD_WIDTH).fill(null));
    }
    
    if (linesCleared > 0) {
      setBoard(newBoard);
      setLines(prev => prev + linesCleared);
      const points = [0, 40, 100, 300, 1200][linesCleared] * level;
      setScore(prev => prev + points);
      const newLineCount = lines + linesCleared;
      setLevel(Math.floor(newLineCount / 10) + 1);
    }
  };

  const moveDown = () => {
    if (!currentPiece || paused || gameOver) return;
    
    const newPos = { ...position, y: position.y + 1 };
    if (checkCollision(currentPiece.shape, newPos)) {
      mergePiece();
    } else {
      setPosition(newPos);
    }
  };

  const hardDrop = () => {
    if (!currentPiece || paused || gameOver) return;
    let newY = position.y;
    while (!checkCollision(currentPiece.shape, { ...position, y: newY + 1 })) {
      newY++;
    }
    setPosition({ ...position, y: newY });
    setTimeout(mergePiece, 50);
  };

  const moveLeft = () => {
    if (!currentPiece || paused || gameOver) return;
    const newPos = { ...position, x: position.x - 1 };
    if (!checkCollision(currentPiece.shape, newPos)) {
      setPosition(newPos);
    }
  };

  const moveRight = () => {
    if (!currentPiece || paused || gameOver) return;
    const newPos = { ...position, x: position.x + 1 };
    if (!checkCollision(currentPiece.shape, newPos)) {
      setPosition(newPos);
    }
  };

  const rotate = () => {
    if (!currentPiece || paused || gameOver) return;
    const rotated = currentPiece.shape[0].map((_, i) =>
      currentPiece.shape.map(row => row[i]).reverse()
    );
    if (!checkCollision(rotated, position)) {
      setCurrentPiece({ ...currentPiece, shape: rotated });
    }
  };

  const showQuizQuestion = () => {
    setPaused(true);
    setShowQuestion(true);
    setCurrentQuestion(QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)]);
  };

  const handleAnswer = (answerIndex) => {
    if (answerIndex === currentQuestion.correct) {
      setCorrectAnswers(prev => prev + 1);
      setScore(prev => prev + 100 * level);
      setPowerUps(prev => ({ ...prev, clearRow: prev.clearRow + 1 }));
    }
    setShowQuestion(false);
    setPaused(false);
    spawnPiece();
  };

  const useClearRow = () => {
    if (powerUps.clearRow > 0 && !gameOver) {
      const newBoard = [...board];
      newBoard.pop();
      newBoard.unshift(Array(BOARD_WIDTH).fill(null));
      setBoard(newBoard);
      setPowerUps(prev => ({ ...prev, clearRow: prev.clearRow - 1 }));
    }
  };

  useEffect(() => {
    const handleKeyPress = (e) => {
      if (e.key === 'ArrowLeft') moveLeft();
      if (e.key === 'ArrowRight') moveRight();
      if (e.key === 'ArrowDown') moveDown();
      if (e.key === 'ArrowUp') rotate();
      if (e.key === ' ') {
        e.preventDefault();
        hardDrop();
      }
      if (e.key === 'p' || e.key === 'P') setPaused(p => !p);
    };
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [currentPiece, position, paused, gameOver]);

  useEffect(() => {
    if (!gameOver && !paused && currentPiece && gameStarted) {
      const speed = Math.max(100, 800 - (level - 1) * 50);
      gameLoopRef.current = setTimeout(moveDown, speed);
      return () => clearTimeout(gameLoopRef.current);
    }
  }, [position, gameOver, paused, level, currentPiece, gameStarted]);

  const startGame = () => {
    setBoard(Array(BOARD_HEIGHT).fill().map(() => Array(BOARD_WIDTH).fill(null)));
    setScore(0);
    setLines(0);
    setLevel(1);
    setGameOver(false);
    setPaused(false);
    setCorrectAnswers(0);
    setPowerUps({ clearRow: 0 });
    setGameStarted(true);
    const first = SHAPES[Math.floor(Math.random() * SHAPES.length)];
    const next = SHAPES[Math.floor(Math.random() * SHAPES.length)];
    setNextPiece(next);
    setCurrentPiece(first);
    setPosition({ x: Math.floor(BOARD_WIDTH / 2) - 1, y: 0 });
  };

  const renderBoard = () => {
    const displayBoard = board.map(row => [...row]);
    
    if (currentPiece) {
      currentPiece.shape.forEach((row, y) => {
        row.forEach((cell, x) => {
          if (cell) {
            const boardY = position.y + y;
            const boardX = position.x + x;
            if (boardY >= 0 && boardY < BOARD_HEIGHT && boardX >= 0 && boardX < BOARD_WIDTH) {
              displayBoard[boardY][boardX] = currentPiece.color;
            }
          }
        });
      });
    }

    return displayBoard.map((row, y) => (
      <div key={y} style={{ display: 'flex', height: CELL_SIZE }}>
        {row.map((cell, x) => (
          <div
            key={`${y}-${x}`}
            style={{
              width: CELL_SIZE,
              height: CELL_SIZE,
              backgroundColor: cell || '#000',
              border: cell ? '2px solid rgba(255,255,255,0.3)' : '1px solid #222',
              boxShadow: cell ? 'inset -2px -2px 4px rgba(0,0,0,0.5), inset 2px 2px 4px rgba(255,255,255,0.3)' : 'none',
            }}
          />
        ))}
      </div>
    ));
  };

  const renderNextPiece = () => {
    if (!nextPiece) return null;
    const grid = Array(4).fill().map(() => Array(4).fill(null));
    nextPiece.shape.forEach((row, y) => {
      row.forEach((cell, x) => {
        if (cell) grid[y][x] = nextPiece.color;
      });
    });

    return grid.map((row, y) => (
      <div key={y} style={{ display: 'flex' }}>
        {row.map((cell, x) => (
          <div
            key={`${y}-${x}`}
            style={{
              width: 20,
              height: 20,
              backgroundColor: cell || '#000',
              border: cell ? '1px solid rgba(255,255,255,0.3)' : '1px solid #111',
              boxShadow: cell ? 'inset -1px -1px 2px rgba(0,0,0,0.5)' : 'none',
            }}
          />
        ))}
      </div>
    ));
  };

  return (
    <div style={{ 
      minHeight: '100vh', 
      backgroundColor: '#0a0a0a',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      fontFamily: 'monospace',
      padding: '20px'
    }}>
      <div style={{ display: 'flex', gap: '20px', alignItems: 'flex-start' }}>
        {/* Left Panel */}
        <div style={{ 
          backgroundColor: '#1a1a1a', 
          padding: '20px', 
          borderRadius: '8px',
          border: '2px solid #333',
          width: '200px'
        }}>
          <div style={{ marginBottom: '20px' }}>
            <div style={{ color: '#fff', fontSize: '14px', marginBottom: '10px', fontWeight: 'bold' }}>SCORE</div>
            <div style={{ color: '#0F0', fontSize: '24px', fontFamily: 'monospace' }}>{score.toString().padStart(6, '0')}</div>
          </div>
          
          <div style={{ marginBottom: '20px' }}>
            <div style={{ color: '#fff', fontSize: '14px', marginBottom: '10px', fontWeight: 'bold' }}>LEVEL</div>
            <div style={{ color: '#0FF', fontSize: '24px', fontFamily: 'monospace' }}>{level}</div>
          </div>

          <div style={{ marginBottom: '20px' }}>
            <div style={{ color: '#fff', fontSize: '14px', marginBottom: '10px', fontWeight: 'bold' }}>LINES</div>
            <div style={{ color: '#FF0', fontSize: '24px', fontFamily: 'monospace' }}>{lines}</div>
          </div>

          <div style={{ marginBottom: '20px' }}>
            <div style={{ color: '#fff', fontSize: '14px', marginBottom: '5px', fontWeight: 'bold' }}>NEXT</div>
            <div style={{ backgroundColor: '#000', padding: '10px', border: '2px solid #333' }}>
              {renderNextPiece()}
            </div>
          </div>

          <div style={{ marginBottom: '20px' }}>
            <div style={{ color: '#fff', fontSize: '14px', marginBottom: '10px', fontWeight: 'bold' }}>BIOLOGY üß¨</div>
            <div style={{ color: '#F0F', fontSize: '18px', marginBottom: '5px' }}>Correct: {correctAnswers}</div>
            <button 
              onClick={useClearRow}
              disabled={powerUps.clearRow === 0}
              style={{
                width: '100%',
                padding: '10px',
                marginTop: '10px',
                backgroundColor: powerUps.clearRow > 0 ? '#F00' : '#333',
                color: '#fff',
                border: 'none',
                borderRadius: '4px',
                cursor: powerUps.clearRow > 0 ? 'pointer' : 'not-allowed',
                fontSize: '12px',
                fontWeight: 'bold'
              }}
            >
              ‚ö° CLEAR ROW ({powerUps.clearRow})
            </button>
          </div>
        </div>

        {/* Game Board */}
        <div style={{ 
          backgroundColor: '#000', 
          padding: '10px',
          border: '4px solid #333',
          borderRadius: '8px',
          boxShadow: '0 0 20px rgba(0,255,0,0.3)'
        }}>
          {!gameStarted && !gameOver && (
            <div style={{
              position: 'absolute',
              width: BOARD_WIDTH * CELL_SIZE,
              height: BOARD_HEIGHT * CELL_SIZE,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: 'rgba(0,0,0,0.9)',
              zIndex: 10
            }}>
              <div style={{ textAlign: 'center' }}>
                <div style={{ color: '#0F0', fontSize: '32px', fontWeight: 'bold', marginBottom: '20px' }}>
                  üå± BIO TETRIS üß¨
                </div>
                <button
                  onClick={startGame}
                  style={{
                    padding: '15px 40px',
                    fontSize: '20px',
                    backgroundColor: '#0F0',
                    color: '#000',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    fontFamily: 'monospace'
                  }}
                >
                  START GAME
                </button>
              </div>
            </div>
          )}
          {renderBoard()}
        </div>

        {/* Right Panel */}
        <div style={{ 
          backgroundColor: '#1a1a1a', 
          padding: '20px', 
          borderRadius: '8px',
          border: '2px solid #333',
          width: '200px',
          color: '#fff'
        }}>
          <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '15px' }}>CONTROLS</div>
          <div style={{ fontSize: '12px', lineHeight: '1.8' }}>
            <div>‚Üê ‚Üí : MOVE</div>
            <div>‚Üë : ROTATE</div>
            <div>‚Üì : SOFT DROP</div>
            <div>SPACE : HARD DROP</div>
            <div>P : PAUSE</div>
          </div>

          {paused && !showQuestion && (
            <div style={{ 
              marginTop: '20px', 
              padding: '10px', 
              backgroundColor: '#FF0', 
              color: '#000',
              textAlign: 'center',
              fontWeight: 'bold',
              fontSize: '18px'
            }}>
              PAUSED
            </div>
          )}
        </div>
      </div>

      {/* Question Modal */}
      {showQuestion && currentQuestion && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.95)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: '#1a1a1a',
            padding: '40px',
            borderRadius: '8px',
            maxWidth: '600px',
            border: '4px solid #0F0',
            boxShadow: '0 0 30px rgba(0,255,0,0.5)'
          }}>
            <div style={{ color: '#0F0', fontSize: '24px', marginBottom: '20px', fontWeight: 'bold', textAlign: 'center' }}>
              üß¨ BIOLOGY CHALLENGE! üå±
            </div>
            <div style={{ color: '#fff', fontSize: '18px', marginBottom: '30px', lineHeight: '1.6' }}>
              {currentQuestion.q}
            </div>
            <div style={{ display: 'grid', gap: '15px' }}>
              {currentQuestion.a.map((answer, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswer(idx)}
                  style={{
                    padding: '15px 20px',
                    fontSize: '16px',
                    backgroundColor: '#333',
                    color: '#fff',
                    border: '2px solid #0F0',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontFamily: 'monospace',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    e.target.style.backgroundColor = '#0F0';
                    e.target.style.color = '#000';
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.backgroundColor = '#333';
                    e.target.style.color = '#fff';
                  }}
                >
                  {answer}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Game Over Modal */}
      {gameOver && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.95)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: '#1a1a1a',
            padding: '40px',
            borderRadius: '8px',
            textAlign: 'center',
            border: '4px solid #F00',
            boxShadow: '0 0 30px rgba(255,0,0,0.5)'
          }}>
            <div style={{ color: '#F00', fontSize: '36px', marginBottom: '20px', fontWeight: 'bold' }}>
              GAME OVER
            </div>
            <div style={{ color: '#fff', fontSize: '18px', marginBottom: '10px' }}>
              FINAL SCORE: {score.toString().padStart(6, '0')}
            </div>
            <div style={{ color: '#fff', fontSize: '16px', marginBottom: '10px' }}>
              LINES: {lines}
            </div>
            <div style={{ color: '#0F0', fontSize: '16px', marginBottom: '30px' }}>
              QUESTIONS CORRECT: {correctAnswers}
            </div>
            <button
              onClick={startGame}
              style={{
                padding: '15px 40px',
                fontSize: '20px',
                backgroundColor: '#0F0',
                color: '#000',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                fontWeight: 'bold',
                fontFamily: 'monospace'
              }}
            >
              PLAY AGAIN
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
